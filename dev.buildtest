#!/bin/bash

CMS_BUILD_IP=173.255.208.122
PACKAGE_PATTERN=downstream-cms-buildtest*.deb
PACKAGE_DIR=./dist

LAST_PACKAGE=$(cat .dev.buildtest.last)

echo "Last package was ${LAST_PACKAGE}"

NEWEST_PACKAGE=$(ssh "downstream@${CMS_BUILD_IP}" "cd ${PACKAGE_DIR}; ls -Art ${PACKAGE_PATTERN} | tail -1")

echo "Newest package is ${NEWEST_PACKAGE}"

if [[ "${NEWEST_PACKAGE}" != "${LAST_PACKAGE}" ]]; then
  echo "Will upload and install"
  scp downstream@${CMS_BUID_IP}:${PACKAGE_DIR}/${NEWEST_PACKAGE} . || exit 1
  apt install -y ./${NEWEST_PACKAGE} || exit 1
fi
